# SD 聊天 - 概览

> v1.0.0
> 2025-12

## 目录

- [环境要求](#环境要求)
- [功能介绍](#功能介绍)
- [前置条件](#前置条件)
- [界面布局](#界面布局)
- [生成模式](#生成模式)
- [基本操作](#基本操作)
  - [创建对话](#创建对话)
  - [发送提示词](#发送提示词)
  - [附件上传](#附件上传)
  - [对话管理](#对话管理)
- [参数配置](#参数配置)
  - [基础参数](#基础参数)
  - [负向提示词模板](#负向提示词模板)
  - [图片保存](#图片保存)
  - [通用高级参数](#通用高级参数)
  - [图生图专属参数](#图生图专属参数)
  - [视频生成专属参数](#视频生成专属参数)
- [消息操作](#消息操作)
- [进度查看](#进度查看)
- [收藏数据](#收藏数据)
- [注意事项](#注意事项)

---

## 环境要求

**本功能需在设置中安装GPU或CPU的环境依赖。**

SD 聊天使用 Stable Diffusion 模型进行图像和视频生成。使用前需确保：

1. 已在**模型库**中成功加载 **Stable Diffusion (图像生成)** 类型的模型
2. 模型支持的生成模式（文生图/图生图/视频）会影响可用功能

> **GPU 加速库（重要）**
>
> - **NVIDIA（推荐；SD 必需）**：
>   - 若检测到 NVIDIA 独立显卡，建议通过“模型库 → 顶部右侧 ⚡ 按钮 → 安装 GPU 加速库”下载安装对应的 CUDA 加速库。聊天/多模态模型在 NVIDIA+CUDA 下性能最佳；Stable Diffusion（SD，图像生成）当前仅支持 CUDA，因此要使用 SD 功能，必须先安装 CUDA 加速库。
>   - 安装或更新加速库后，无需重启应用，下次加载模型时会自动生效。
> - **AMD（限制）**：
>   - AMD 显卡可使用内置的 Vulkan 加速来运行聊天/多模态模型（无需额外安装），但 SD 推理目前不支持 AMD/Vulkan，因此在 AMD 显卡上无法使用 SD 功能。
> - **无独立显卡 / 集成显卡**：
>   - 若系统未检测到独立 NVIDIA 显卡，“安装 GPU 加速库”按钮不会显示。可使用 CPU 或平台 Vulkan（在受支持的场景下）运行聊天模型，但性能会受限。

---

## 功能介绍

SD 聊天是一个专门用于 Stable Diffusion 图像/视频生成的对话界面，支持：

- **文生图 (Text-to-Image)**：根据文本提示词生成图像
- **图生图 (Image-to-Image)**：基于输入图片和提示词进行图像转换
- **视频生成 (Video)**：生成动态视频内容

每个对话可以独立配置生成参数（分辨率、采样步数、CFG、种子等），支持多轮对话式生成，便于调试和对比效果。

---

## 前置条件

1. **必须先加载 SD 模型**
   - 进入 **模型库** 页面
   - 在 **Stable Diffusion (图像生成)** 标签页中加载模型
   - 模型加载成功后，SD 聊天页面会自动解锁

2. **了解模型能力**
   - 不同 SD 模型支持的功能不同：
     - 基础模型：通常支持文生图
     - 图生图模型：支持文生图 + 图生图
     - 视频模型：支持视频生成（可能包含文生图/图生图）
   - 在模型库中查看模型详情可了解支持的能力

---

## 界面布局

SD 聊天界面采用左右双栏布局：

### 左侧栏（对话列表）
- **新建对话** 按钮：位于顶部
- **对话列表**：按时间分组显示（今天/昨天/最近7天/最近30天/更早）
  - 显示对话缩略图（首张生成图片）
  - 显示对话标题（自动根据首条提示词生成）

### 右侧栏（聊天区域）
- **消息列表**：显示用户提示词和 AI 生成的图片/视频
- **进度条**：生成过程中显示在消息列表下方
- **输入框**：底部，用于输入提示词
- **附件按钮**：输入框左侧（仅在支持图生图或视频时显示）
- **参数按钮**：输入框底部工具栏，点击打开参数抽屉
- **生成按钮**：输入框底部工具栏右侧

> **未加载模型时的提示**：右侧会显示"前往模型库 加载<图像生成模型>"按钮，点击可跳转到模型库。

---

## 生成模式

**配额消耗**：每次成功生成会消耗 1 次"数据"配额（加载模型后首次生成计数）。

SD 聊天根据加载的模型能力，自动支持以下模式：

| 模式 | 说明 | 附件要求 | 生成内容 |
|-----|------|---------|---------|
| **文生图** | 根据文本提示词生成图像 | 不显示附件区 | 图片（1-16张，取决于 `批量生成` 参数） |
| **图生图** | 基于输入图片进行图像转换 | 可选上传图片（未上传时自动降级为文生图） | 图片（1-16张） |
| **视频生成** | 生成动态视频 | 可选上传初始帧图片 | 视频文件 + 视频帧图片 |

> **自动模式切换**：
> - 文生图模式：不显示附件按钮
> - 图生图/视频模式：显示附件按钮，支持上传图片（JPG、PNG 格式）

---

## 基本操作

### 创建对话

1. 点击左侧栏顶部的 **新建对话** 按钮
2. 系统会创建一个新对话并自动切换到该对话
3. 对话标题会在首次发送提示词后自动生成（基于提示词内容）

> **注意**：同一时间只能有一个空对话，必须先使用或删除空对话才能创建新对话。

### 发送提示词

1. 在输入框中输入提示词
2. 点击 **生成** 按钮（或按 `Ctrl+Enter`）
3. 系统会立即显示用户消息，并开始生成
4. 生成完成后，AI 消息会显示生成的图片/视频

> **提示**：
> - 提示词支持英文和中文，但英文提示词通常效果更好
> - 提示词越具体详细，生成效果越接近预期
> - 过长提示词可能导致生成失败，建议控制在 500 字符以内

### 附件上传

**仅在图生图或视频模式下显示附件功能。**

1. 点击输入框左侧的 **附件图标**（链接图标，有附件时显示红点徽章）
2. 支持两种方式添加图片：
   - **点击上传区域**：选择本地图片文件
   - **拖拽文件**：直接拖拽图片到上传区域
3. 支持的图片格式：JPG、JPEG、PNG
4. 每次只使用第一张上传的图片
5. 点击附件卡片的删除按钮可移除

> **图生图模式特别说明**：
> - 上传图片后会使用图生图模式进行转换
> - 不上传图片会自动降级为文生图模式

> **视频模式特别说明**：
> - 附件是可选的，不上传图片则使用纯文生视频模式
> - 上传图片后，图片会作为视频的初始帧

### 对话管理

#### 选择对话
- 点击左侧列表中的对话项即可切换

#### 重命名对话
1. 右键点击对话项（或点击对话右侧的 `···` 菜单）
2. 选择 **重命名**
3. 输入新标题（最多 80 字符）
4. 点击 **确定**

> **自动标题**：首次发送提示词后，系统会自动根据提示词生成标题（最多 30 字符）。重命名后不再自动更新。

#### 删除对话
1. 右键点击对话项
2. 选择 **删除**
3. 确认删除（会同时删除对话中的所有消息和生成的图片记录）

---

## 参数配置

点击输入框底部工具栏的 **参数按钮**（滑块图标）打开参数抽屉。

### 基础参数

以下参数适用于所有生成模式：

| 参数 | 默认值 | 范围 | 说明 |
|-----|-------|------|------|
| **宽度 (Width)** | 768 | 64-2048 (步长64) | 生成图像的宽度（像素） |
| **高度 (Height)** | 768 | 64-2048 (步长64) | 生成图像的高度（像素） |
| **采样步数 (Sample Steps)** | 20 | 1-200 | 生成迭代次数，步数越多质量越高但速度越慢 |
| **CFG 强度 (CFG Scale)** | 7.0 | 0-30 (步长0.5) | 提示词遵循程度，值越高越严格遵循提示词 |
| **随机种子 (Seed)** | 随机 | 0-99999999 | 控制生成随机性，相同种子产生相似结果 |

> **分辨率建议**：
> - 标准：512×512、768×768
> - 宽屏：1024×576、1280×720
> - 竖屏：576×1024、720×1280
> - 高分辨率会消耗更多 VRAM 和时间

### 负向提示词模板

负向提示词用于排除不想要的元素（如 "低质量、模糊、变形" 等）。

**使用模板**：
1. 点击负向提示词输入框上方的 **选择框**
2. 从下拉列表中选择预设模板（如 "通用负向提示词"）
3. 模板内容会自动填充到输入框

**保存模板**：
1. 编辑负向提示词内容
2. 点击 **另存为** 按钮
3. 输入模板名称
4. 点击 **确定**

**删除模板**：
1. 先选择要删除的模板
2. 点击 **删除图标**（垃圾桶）
3. 确认删除

> **注意**：模板数据存储在应用本地数据库中，删除模板后无法恢复。卸载应用不会删除数据库。

### 图片保存

| 参数 | 默认值 | 可选值 | 说明 |
|-----|-------|-------|------|
| **保存目录** | 空（使用临时目录） | 任意本地路径 | 指定图片保存位置，留空则保存到本应用的系统临时目录 |
| **图片格式** | PNG | PNG、JPEG、WebP | PNG 无损但体积大，JPEG 有损但体积小 |
| **图片质量** | 85 | 1-100 | 仅对 JPEG/WebP 格式生效，PNG 格式自动禁用此选项 |

> **视频帧说明**：视频生成的帧图片始终使用 PNG 格式（无损），确保视频质量。

### 通用高级参数

展开 **通用高级参数** 折叠面板查看以下选项：

| 参数 | 默认值 | 范围 | 说明 |
|-----|-------|------|------|
| **采样方法 (Sample Method)** | default | euler、euler_a、ddim、dpmpp_2m 等 | 不同算法速度和质量不同 |
| **调度器 (Scheduler)** | default | normal、karras、exponential 等 | 控制采样过程的噪声调度 |
| **引导强度 (Guidance)** | 3.5 | 0-30 (步长0.5) | 无分类器引导强度，影响生成细节 |
| **批量生成 (Batch Count)** | 1 | 1-16 | 一次生成多少张图片（不支持视频模式） |
| **放大倍数 (Upscale Factor)** | 1 | 1-4 | 生成后自动放大图片 |
| **CLIP 跳过层数 (CLIP Skip)** | -1 | -1 到 12 | 跳过 CLIP 最后几层，-1 表示不跳过 |

> **采样方法选择建议**：
> - **euler**：速度快，适合快速预览
> - **euler_a**：稳定性好，适合大多数场景
> - **dpmpp_2m**：质量高，但速度较慢

### 图生图专属参数

展开 **图生图模式参数** 折叠面板（仅在图生图模式下显示）：

| 参数 | 默认值 | 范围 | 说明 |
|-----|-------|------|------|
| **变化强度 (Strength)** | 0.55 | 0-1 (步长0.01) | 控制生成图像与原图的相似度，0=完全相同，1=完全重绘 |
| **VAE 分块 (VAE Tiling)** | 关闭 | 开/关 | 降低 VRAM 占用，处理大图时推荐开启 |

> **Strength 参数指南**：
> - **0.3-0.5**：微调细节，保留原图主体
> - **0.5-0.7**：平衡改变，推荐范围
> - **0.7-1.0**：大幅改变，接近重新生成

### 视频生成专属参数

展开 **视频模式参数** 折叠面板（仅在视频模式下显示）：

| 参数 | 默认值 | 说明 |
|-----|-------|------|
| **视频帧数** | 等同于采样步数 | 生成的视频总帧数，由 `采样步数` 参数控制（1-200 帧） |

> **视频参数说明**：
> - 视频模式下，`采样步数` 同时控制生成质量和视频长度
> - 步数越多，视频时长越长，但生成时间也越长
> - 推荐 20-60 帧（约 1-4 秒视频，取决于 FPS）

---

## 消息操作

### 用户消息操作

悬停在用户消息上会显示操作按钮（右侧浮动工具栏）：

- **编辑**：修改提示词内容（不会重新生成）
- **复制**：复制提示词到剪贴板
- **删除**：删除该消息（不影响其他消息）
- **重新发送**：使用相同提示词重新生成

> **重新发送注意事项**：
> - 会保留原始消息的生成模式（文生图/图生图/视频）
> - 图生图模式需要原始消息包含源图片，否则自动回退到文生图
> - 如果当前未加载模型，会提示"未加载 Stable Diffusion 模型"

### AI 消息操作

悬停在 AI 消息上会显示：

- **图片另存为**：将生成的图片保存到本地
- **复制**：复制消息内容（如果有文本）
- **删除**：删除该消息

### 图片保存

1. 点击 **图片另存为** 按钮（下载图标）
2. 系统会弹出文件保存对话框
3. 文件名默认格式：`{对话标题}_{时间戳}.{格式}`
4. 选择保存位置并确认

> **批量保存**：如果一次生成了多张图片（批量生成），每张图片需要分别保存。

### 视频操作

视频消息会显示：
- **内联播放器**：直接在聊天界面播放
- **在系统播放器中打开** 按钮：使用系统默认播放器打开

---

## 进度查看

### 进度条显示

生成过程中，消息列表下方会显示进度条：
- **进度百分比**：当前步数 / 总步数
- **停止生成** 按钮：点击可取消当前生成任务

### 停止生成

1. 点击 **停止生成** 按钮
2. 系统会发送取消请求（按钮变为"正在取消..."）
3. 取消成功后，进度条消失，不会保存部分生成的图片

> **注意**：取消操作不可撤销，已消耗的生成时间和资源无法恢复。

---

## 数据收藏

### 点赞收藏（预留功能）

右下角的 **书本图标** 浮动按钮用于查看数据收藏。当前版本暂未开放 SD 聊天的点赞功能，未来版本会支持收藏生成结果用于图文模型的训练。

---

## 注意事项

### 模型要求

1. **必须先加载模型**
   - SD 聊天完全依赖 Stable Diffusion 模型
   - 未加载模型时，只能查看历史对话，无法发送新消息

2. **模型能力检测**
   - 系统会自动检测模型支持的能力（文生图/图生图/视频）
   - 不支持的功能会自动隐藏（如文生图模型不显示附件按钮）

3. **模型切换**
   - 切换模型后，新对话会使用新模型的能力
   - 历史对话保持原模型的生成记录

### 参数设置

1. **参数独立性**
   - 每个对话有独立的参数配置
   - 修改参数只影响当前对话的后续生成
   - 新建对话会使用默认参数

2. **参数持久化**
   - 参数设置会自动保存到浏览器本地存储
   - 清除浏览器数据会丢失自定义参数

3. **重置按钮**
   - 每个参数右侧的 **重置图标**（刷新）可恢复该参数的默认值

### 附件限制

1. **图片格式**
   - 仅支持 JPG、JPEG、PNG 格式
   - 不支持 GIF、WebP、BMP 等格式

2. **图片大小**
   - 建议单张图片不超过 10MB
   - 超大图片可能导致内存占用过高

3. **附件数量**
   - 每次只使用第一张上传的图片
   - 上传多张图片时，系统会忽略除第一张外的其他图片

### 生成限制

1. **并发限制**
   - 同一时间只能有一个生成任务
   - 生成过程中无法发送新消息

2. **资源占用**
   - 高分辨率 + 高步数会消耗大量 VRAM 和时间
   - 建议根据硬件配置调整参数：
     - **4GB VRAM**：512×512，步数 20-30
     - **8GB VRAM**：768×768，步数 30-50
     - **12GB+ VRAM**：1024×1024，步数 50+

3. **视频生成特别注意**
   - 视频生成比图片生成耗时更长（通常是 5-10 倍）
   - 推荐先用低帧数测试（20 帧），确认效果后再增加

### 数据管理

1. **历史记录**
   - 对话和消息持久化存储在本地数据库
   - 卸载应用不会删除本地数据库

2. **图片存储**
   - 生成的图片默认保存在系统临时目录
   - 重要图片建议及时另存为到指定位置
   - 设置 **保存目录** 参数可指定默认保存位置

3. **懒加载机制**
   - 对话列表支持懒加载（滚动到底部自动加载更多）
   - 消息列表支持懒加载（滚动到顶部加载历史消息）

### 常见问题

**Q：为什么点击"生成"按钮没有反应？**

A：检查以下几点：
1. 是否已加载 SD 模型（未加载时界面会显示"前往模型库 加载<图像生成模型>"提示）
2. 提示词是否为空
3. 是否有正在进行的生成任务

**Q：生成的图片质量不理想怎么办？**

A：尝试以下调整：
1. 增加采样步数（推荐 30-50）
2. 调整 CFG 强度（推荐 7-12）
3. 使用更详细的提示词
4. 添加负向提示词排除不想要的元素
5. 尝试不同的采样方法

**Q：为什么图生图效果与原图差异太大？**

A：降低 **变化强度 (Strength)** 参数（推荐 0.3-0.6）。

**Q：视频生成失败或卡住怎么办？**

A：
1. 降低视频帧数（推荐 20-40 帧）
2. 降低分辨率（推荐 512×512 或 768×768）
3. 检查 VRAM 是否充足
4. 点击"停止生成"后重新尝试

**Q：如何复现之前生成的图片？**

A：
1. 查看历史消息的生成参数（悬停在图片上可能显示）
2. 使用相同的提示词、负向提示词
3. 设置相同的随机种子
4. 确保其他参数（分辨率、步数、CFG 等）也一致

**Q：为什么有些参数显示为灰色不可用？**

A：
- **图片质量**：仅在 JPEG/WebP 格式下可用
- **批量生成**：视频模式下不可用
- **图生图参数**：仅在图生图模式下可用
- **视频参数**：仅在视频模式下可用

---

## 下一步

- 了解如何在 [模型库](../models/overview.md) 中导入和加载 SD 模型
- 查看 [提示词生成](../chat/prompt-generation.md) 功能，学习如何优化提示词
- 探索 [数据收藏](../chat/personalized-data.md) 功能，收藏优质生成结果
