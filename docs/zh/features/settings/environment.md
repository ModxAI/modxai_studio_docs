# 环境安装详解

> v1.0.0
> 2025-12

本文详细介绍 ModxAI Studio 的**环境配置**功能，帮助您理解环境安装的原理、操作流程和故障排除方法。

## 目录

- [功能概述](#功能概述)
- [存储位置与空间要求](#存储位置与空间要求)
- [GPU 检测标准](#gpu-检测标准)
- [NVIDIA 驱动与 CUDA 配置](#nvidia-驱动与-cuda-配置)
- [环境类型选择](#环境类型选择)
- [安装内容详解](#安装内容详解)
- [操作说明](#操作说明)
- [安装流程详解](#安装流程详解)
- [故障排除](#故障排除)

---

## 功能概述

环境配置是 ModxAI Studio 的核心亮点功能，采用以下技术策略：

| 特性 | 说明 |
|------|------|
| **一键安装** | 自动配置便携式 Python 环境和所有依赖库 |
| **沙箱隔离** | 完全独立于系统 Python，不影响现有开发环境 |
| **差异化加载** | 按需安装，未使用的功能模块不会安装对应依赖 |
| **动态加载** | 运行时按需加载库，启动速度快，内存占用低 |
| **断点续传** | 安装中断后可继续，已下载的文件会保留 |
| **即装即用** | 安装完成后无需重启应用，功能立即可用 |

---

## 存储位置与空间要求

### 安装位置

环境依赖包安装在**系统用户目录**下的持久化路径中：

| 操作系统 | 路径示例 |
|----------|----------|
| Windows | `C:\Users\<用户名>\AppData\Local\ModxAI\packages` |

> ⚠️ **注意**：安装位置位于系统盘，请确保系统盘有足够的可用空间。

### 空间要求

| 环境类型 | 最小可用空间 | 推荐可用空间 |
|----------|--------------|--------------|
| CPU 环境 | **10 GB** | 15 GB |
| GPU 环境 | **10 GB** | 20 GB |

> 💡 **说明**：
> - GPU 环境需要下载 CUDA 版本的 PyTorch，体积较大
> - 如果安装可选的加速库（如 bitsandbytes），需要额外空间
> - 安装过程中会有临时文件，完成后会自动清理

---

## GPU 检测标准

系统会自动检测显卡类型，不同显卡的支持情况如下：

### NVIDIA 显卡

| 检测项 | 检测方式 | 通过标准 |
|--------|----------|----------|
| 显卡存在 | 调用 `nvidia-smi` | 命令执行成功且返回显卡信息 |
| 驱动版本 | 解析 `nvidia-smi` 输出 | 驱动版本号不为空 |
| CUDA 版本 | 调用 `nvcc --version` | 返回 CUDA 版本 ≥ 11.8 |
| 显存大小 | 解析 `nvidia-smi` 输出 | 用于显示，不影响安装 |

### AMD 显卡

| 检测项 | 检测方式 | 说明 |
|--------|----------|------|
| 显卡存在 | 读取 Windows 注册表或 WMI | 检测 Radeon 系列独显 |
| 显存大小 | 读取 AdapterRAM | 用于显示 |

> ⚠️ **AMD 显卡限制**：
> - Windows 平台下，AMD GPU 暂无官方 ROCm 支持
> - 选择 GPU 环境时，会**自动回退到 CPU 版本的 PyTorch**
> - AMD 显卡用户建议直接选择 CPU 环境, 但不影响推理时的加速

### 无独立显卡

如果系统未检测到独立显卡（仅有集成显卡或无显卡）：

- GPU 选项会被禁用
- 只能安装 CPU 环境
- 所有功能均可正常使用，但推理和训练速度较慢

---

## NVIDIA 驱动与 CUDA 配置

> ⚠️ **重要提示**：环境安装功能**不会自动安装** NVIDIA 驱动和 CUDA Toolkit，用户需要自行配置。

### 驱动要求

| 组件 | 最低版本 | 推荐版本 | 下载地址 |
|------|----------|----------|----------|
| NVIDIA 驱动 | 450.80+ | 最新稳定版 | [NVIDIA 驱动下载](https://www.nvidia.cn/Download/index.aspx) |
| CUDA Toolkit | 11.8 | 12.0-12.9 | [CUDA 下载](https://developer.nvidia.com/cuda-downloads) |
| cuDNN（可选） | 8.6+ | 8.9+  | [cuDNN 下载](https://developer.nvidia.com/cudnn)（需注册账号） |

### CUDA 版本对应关系

系统会根据检测到的 CUDA 版本自动选择合适的 PyTorch 版本：

| 本机 CUDA 版本 | 安装的 PyTorch 版本 |
|----------------|---------------------|
| CUDA 11.7 及以下 | 回退到 CUDA 11.8 版本 |
| CUDA 11.8 | PyTorch + CUDA 11.8 |
| CUDA 12.1 | PyTorch + CUDA 12.1 |
| CUDA 12.4 | PyTorch + CUDA 12.4 |
| CUDA 12.6 | PyTorch + CUDA 12.6 |
| CUDA 12.8+ | PyTorch + CUDA 12.8 |

### cuDNN 加速（可选）

cuDNN 是 NVIDIA 的深度学习加速库，可显著提升训练和推理速度：

- **安装建议**：如果进行模型训练和音频处理，强烈建议安装 cuDNN
- **版本选择**：选择与 CUDA 版本匹配的 cuDNN（如 CUDA 12.x 配 cuDNN 9.x）
- **安装方式**：下载后解压，将 `bin`、`include`、`lib` 目录内容复制到 CUDA 安装目录

### 检查 CUDA 是否正确安装

在命令行中执行以下命令验证：

```bash
# 检查 NVIDIA 驱动
nvidia-smi

# 检查 CUDA 版本
nvcc --version
```

如果命令执行失败或提示找不到命令，说明驱动或 CUDA 未正确安装或未添加到系统 PATH。

---

## 环境类型选择

### CPU 环境

| 适用场景 | 说明 |
|----------|------|
| 无独立显卡 | 集成显卡或无显卡的设备 |
| AMD 显卡 | Windows 平台 AMD GPU 暂不支持训练时的 GPU 加速, 但推理支持 |
| 轻量使用 | 仅进行小规模数据处理或推理测试 |
| 开发调试 | 功能验证，不追求性能 |

**特点**：
- 下载体积较小（约 2-3 GB）
- 不依赖 CUDA 环境
- 所有功能可用，但速度较慢

### GPU 环境

| 适用场景 | 说明 |
|----------|------|
| NVIDIA 显卡 | 拥有 NVIDIA 独立显卡且已安装 CUDA |
| 模型训练 | 需要 GPU 加速的训练任务 |
| 大规模推理 | 批量处理或实时推理场景 |
| 性能优先 | 追求最佳处理速度 |

**特点**：
- 下载体积较大（约 4-6 GB，含 CUDA 版 PyTorch）
- 需要正确配置 NVIDIA 驱动和 CUDA
- 训练速度提升 10-100 倍（取决于显卡性能）

### 环境互斥

> ⚠️ **重要**：CPU 环境和 GPU 环境**不能同时安装**，二者互斥。

- 切换环境类型前，需要先**清理**当前已安装的环境
- 如果检测到另一环境已存在，安装按钮会被禁用
- 界面会提示"检测到环境互斥"，指引用户先执行清理

---

## 安装内容详解

### 便携式 Python

| 组件 | 版本 | 说明 |
|------|------|------|
| Python | 3.11.9 | Windows 嵌入式版本，完全独立 |
| pip | 最新版 | 包管理工具 |

便携式 Python 会首先下载并解压，后续所有依赖都安装到隔离的 `packages` 目录中。

### 核心依赖库

根据环境类型安装对应版本的核心库：

| 库名称 | CPU 版本 | GPU 版本 | 用途 |
|--------|----------|----------|------|
| PyTorch | torch (CPU) | torch + CUDA | 深度学习框架 |
| torchvision | CPU 版 | CUDA 版 | 图像处理 |
| torchaudio | CPU 版 | CUDA 版 | 音频处理 |

### 基础功能库

无论选择 CPU 还是 GPU 环境，都会安装以下基础库：

| 库名称 | 版本 | 用途 |
|--------|------|------|
| transformers | 4.52+ | Hugging Face 模型库 |
| sentence-transformers | 4.0+ | 向量模型推理 |
| trl | 0.15+ | 强化学习训练 |
| peft | 0.15+ | 高效微调（LoRA 等）|
| sentencepiece | 0.2+ | 分词器 |
| faster-whisper | 1.2+ | 语音识别 |
| pandas | 2.3+ | 数据处理 |
| matplotlib | 3.10+ | 图表绘制 |
| jieba | 0.42+ | 中文分词 |
| spacy | 3.8+ | NLP 处理 |
| markitdown | 0.1+ | Markdown 解析 |
| mistral_common | 1.8+ | Mistral 模型支持 |

### 可选加速库（GPU 环境）

GPU 环境安装时会**异步尝试**安装以下可选库，失败不影响主流程：

| 库名称 | 用途 | 说明 |
|--------|------|------|
| bitsandbytes | 4/8-bit 量化 | 降低显存占用，加速训练 |

### TTS 可选依赖库

TTS（语音合成）功能需要以下可选依赖，在主环境安装完成后**异步安装**：

| 库名称 | 用途 | 说明 |
|--------|------|------|
| misaki[en,zh] | G2P 转换 | 字素到音素转换，支持中英文 |

> ⚠️ **TTS 依赖安装说明**：
> - misaki 库强制使用 **PyPI 官方源**安装，因国内镜像源对 extras 依赖解析不完整
> - 中国大陆用户下载可能较慢或失败，请保持网络稳定
> - 安装失败不影响主环境，可通过**重新安装**或**修复环境**重试
> - 安装成功后，需刷新环境状态确认 TTS 能力是否可用

### 可选模型资源

安装完成后会异步下载以下模型资源：

| 资源 | 大小 | 用途 |
|------|------|------|
| en_core_web_sm | ~14 MB | spaCy 英文模型（NLP 处理、TTS 中英文 G2P） |
| zh_core_web_sm | ~75 MB | spaCy 中文模型（中文分词、TTS 中文 G2P） |

> 💡 **说明**：
> - 模型资源下载失败不影响环境安装状态，后续使用相关功能时可重试下载
> - **TTS 功能依赖**：TTS 语音合成功能需要 spaCy 模型完成 G2P 转换
> - **异步下载延迟**：这些模型在主环境安装完成后**异步下载**，下载时间取决于网络状况，可能延迟数十秒至数分钟
> - **能力状态**：主环境安装完成后，请**刷新环境状态**确认各项能力（包括 TTS）是否可用
> - 若 TTS 能力显示不可用，可通过**重启应用**或**修复安装**再次下载相关依赖

---

## 操作说明

### 刷新

点击**刷新**按钮会执行以下操作：

1. 重新检测系统硬件信息（CPU、内存、GPU）
2. 重新检测 NVIDIA 驱动和 CUDA 版本
3. 重新检测已安装的依赖包状态
4. 运行验证脚本确认环境可用性

> ⚠️ **注意**：首次刷新或环境变更后刷新可能较慢（10-30 秒），因为需要执行验证脚本检测各个库的版本和 CUDA 支持状态。

### 安装

点击**安装**按钮开始安装流程：

1. 确认安装（弹出确认对话框显示选择的镜像源）
2. 显示进度条和实时安装日志
3. 安装完成后**自动刷新**环境状态
4. 安装成功后**无需重启应用**，功能立即可用

> ⚠️ **注意**：安装过程中尽量保持网络连接稳定，避免中断。建议非必要，不要轻易手动停止安装。

### 重装

如果环境已安装，安装按钮会变为**重装**：

- 重装会覆盖现有环境
- 适用于环境损坏或需要更新依赖版本的情况

### 清理

点击**清理**按钮会删除已安装的环境：

1. 确认清理（弹出确认对话框）
2. 删除 `packages` 目录下的所有依赖

> ⚠️ **清理失败处理**：
> 
> 如果清理时提示"文件被占用"或"清理失败"，这通常是因为某些库（如 PyTorch）已被当前进程加载。
> 
> **解决方法**：
> - 点击"重启"按钮重启应用
> - 重启后再次执行清理操作
> - 清理完成后才能切换到另一种环境类型

### 停止安装

安装过程中可以点击**停止安装**按钮中断：

- 已下载的包会保留，下次安装时可复用
- 停止后环境状态会标记为"失败"
- 可以随时重新开始安装

---

## 安装流程详解

完整的安装流程包括以下阶段：

开始 → 准备便携式Python → 预清理检查 → 安装训练环境 
     → 安装加速库(可选) → 安装基础依赖 → 下载模型(可选) 
     → 验证环境 → 完成

### 各阶段说明

| 阶段 | 说明 | 预计时间 |
|------|------|----------|
| prepare_portable_python | 下载/解压便携式 Python | 1-5 分钟 |
| preclean | 检查并清理不兼容的旧环境 | < 1 分钟 |
| training_requirements | 安装 PyTorch 等训练核心库 | 5-20 分钟 |
| accelerate_optional | 异步安装可选加速库 | 后台进行 |
| base_requirements | 安装 transformers 等基础库 | 3-10 分钟 |
| download_models | 异步下载 spaCy 模型 | 后台进行 |
| verify | 验证环境完整性 | 1-2 分钟 |
| finalize | 刷新状态并完成 | < 1 分钟 |

> 💡 **时间说明**：实际安装时间取决于网络速度和选择的镜像源。中国大陆用户建议选择（阿里云/腾讯云）镜像源通常更快。

---

## 故障排除

### 常见问题

#### 1. 安装失败：网络超时

**现象**：安装过程中提示下载失败或超时

**解决方法**：
- 切换镜像源
- 检查网络连接，确保可以访问外网
- 关闭 VPN 或代理软件后重试
- 点击"安装"重试，已下载的文件会复用

#### 2. 安装失败：磁盘空间不足

**现象**：提示磁盘空间不足

**解决方法**：
- 清理系统盘（C 盘）的临时文件
- 确保至少有 10 GB 可用空间
- 卸载不需要的软件释放空间

#### 3. GPU 环境安装后检测为 CPU

**现象**：安装 GPU 环境后，torch.cuda.is_available() 返回 False

**可能原因**：
- CUDA 未正确安装
- CUDA 版本与 PyTorch 版本不匹配
- NVIDIA 驱动版本过低

**解决方法**：
1. 在命令行执行 `nvidia-smi` 确认驱动正常
2. 执行 `nvcc --version` 确认 CUDA 已安装
3. 如果 CUDA 版本过低，升级到 11.8 或更高版本
4. 清理当前环境后重新安装

#### 4. 清理失败：文件被占用

**现象**：清理时提示"部分文件可能被系统占用"

**解决方法**：
- 点击"重启"按钮重启应用
- 重启后立即执行清理操作
- 如果仍然失败，手动重启电脑后再试

#### 5. 刷新很慢

**现象**：点击刷新后等待很长时间

**原因**：首次刷新需要执行验证脚本，检测各个库的版本和 CUDA 支持状态

**说明**：这是正常现象，后续刷新会使用缓存，速度会明显加快

#### 6. 环境互斥提示

**现象**：提示"检测到另一环境的核心包存在"

**解决方法**：
1. 先点击"清理"删除当前环境
2. 如果清理失败，重启应用后再清理
3. 清理成功后再安装目标环境

### 安装日志

安装过程中的日志会实时显示在进度卡片中：

- 展开"安装日志"可查看详细信息
- 日志内容可帮助定位安装失败的具体原因
- 如需技术支持，请提供完整的安装日志

---

## 后续文档

- [全局设置概述](./overview.md) - 返回设置功能概述
- [授权激活详解](./license.md) - 授权类型说明和激活流程
