# 收藏数据

> v1.0.0
> 2025-12

本文介绍如何使用 ModxAI Studio 的**收藏数据**功能,收集、管理和导出对话数据,用于模型微调或RAG知识库构建。

## 目录

- [环境要求](#环境要求)
- [前置条件](#前置条件)
- [功能介绍](#功能介绍)
- [收集数据](#收集数据)
- [管理数据](#管理数据)
- [导出数据](#导出数据)
- [导出格式说明](#导出格式说明)
- [重要注意事项](#重要注意事项)
- [使用技巧](#使用技巧)

---

## 环境要求

### 基础功能(收集和管理)

**无需额外环境依赖**

- 数据收集和管理功能无需依赖模型和Python环境

### 高级功能(导出SFT格式)

**推荐安装Python环境以获得最佳效果**

如果需要导出用于模型微调的SFT格式数据:

| 环境状态 | 分词方式 | 效果 | 说明 |
|---------|---------|------|------|
| **已安装Python环境** | transformers精确分词 | ⭐⭐⭐⭐⭐ 准确 | 使用模型官方tokenizer,确保训练数据token边界准确 |
| **未安装Python环境** | 轻量估算分词 | ⭐⭐⭐ 可用 | 使用字符长度估算,可能存在token边界偏差 |

**建议**:
- 如果您计划进行模型微调训练,请在"设置"中下载Python环境
- 如果仅用于RAG格式导出,无需安装Python环境

---

## 功能介绍

**收藏数据功能的核心作用**:

1. **收集高质量对话数据**:从实际对话中筛选优质问答对
2. **统一管理训练素材**:编辑、查看、删除收藏的数据
3. **导出专业格式数据**:
   - **SFT格式**:用于模型微调训练
   - **RAG格式**:用于构建RAG知识库

### 典型使用场景

#### 场景1:模型微调训练
```
1. 在日常对话中,点赞优质的AI回答
2. 积累足够数量的问答对(建议100+条)
3. 导出SFT格式数据
4. 使用训练功能进行模型微调
```

#### 场景2:RAG知识库构建
```
1. 收集特定领域的专业问答对
2. 导出RAG格式数据
3. 放入RAG数据处理流程生成向量
4. 用于RAG检索增强对话
```

---

## 收集数据

### 方法1:对话中点赞(推荐)

在聊天界面中,对AI的回答进行评价:

1. **点赞图标**(👍):收集这条问答对
   - 问题:您发送的消息
   - 答案:AI的回复
   - 思考过程(可选):如果启用了思维链,会一并保存

2. **取消点赞**:再次点击👍图标,取消收藏

**自动保存**:
- 点赞后立即保存到本地数据库
- 右下角收藏按钮数字实时更新

### 方法2:编辑补充数据

在数据管理界面中,可以:
- 手动编辑问题和答案内容
- 调整数据状态(待处理/已导出/已训练等)

---

## 管理数据

### 打开数据管理界面

在聊天页面右下角,点击**收藏数据按钮**(显示数字统计):

```
📊 12条数据
```

### 数据列表功能

#### 查看数据
- **问题列**:显示用户提问内容(鼠标悬停查看完整内容)
- **回答列**:显示AI回复内容(鼠标悬停查看完整内容)
- **状态列**:显示数据状态
  - 🟠 **待处理**:新收集的数据
  - 🔵 **已导出**:已导出过但未训练
  - 🟢 **已训练**:已用于训练
  - 🔴 **失败**:处理失败的数据
- **创建时间**:收藏时间

#### 筛选和排序
- **状态筛选**:点击状态列标题,按状态过滤数据
- **时间排序**:点击创建时间列标题,按时间排序
- **快速选择**:
  - 全选:选择当前页所有数据
  - 反选:反转当前选择
  - 选择待训练项:仅选择"待处理"状态的数据

#### 数据操作
- **详情**:查看完整的问题、答案和元数据
- **编辑**:修改问题、答案或状态
- **删除**:删除不需要的数据(不可恢复)

**重要**:删除数据会自动取消对应消息的点赞状态。

---

## 导出数据

### 导出流程

#### 1. 选择数据
在数据管理界面,勾选要导出的数据:
- 可以跨页选择
- 建议单次导出数量:50-200条

#### 2. 点击导出按钮
点击表格下方的**"导出"**按钮,打开导出配置对话框。

#### 3. 配置导出参数

##### 基础配置

**导出名称**(必填):
```
示例:customer_service_qa
说明:仅支持字母、数字、下划线和短横线
```

**输出目录**(必填):
```
点击文件夹图标选择保存位置
建议:创建专门的训练数据目录
```

**数量限制**:
```
默认:100
范围:1 到 已选数据总数
说明:限制本次导出的数据条数
```

**启用质量过滤**:
```
☑ 启用:过滤过短或无意义的问答对
☐ 禁用:导出所有选中的数据

子选项(启用时显示):
- 最小问答字符长度:默认2,范围1-100
```

##### 导出格式(关键)

**SFT训练格式**:
```
用途:模型微调训练
输出:两个文件
  1. {名称}_{批次号}_{数量}.jsonl (明文messages格式)
  2. chat_dataset/{名称}_{批次号}_{数量}_train.jsonl (向量化格式,可直接用于训练)

格式示例:
{"messages": [
  {"role": "user", "content": "什么是机器学习?"},
  {"role": "assistant", "content": "机器学习是..."}
]}
```

**RAG Pipeline格式**:
```
用途:构建RAG知识库
输出:一个文件
  opt3_dataset_rag_{名称}_{批次号}.json

格式:与RAG数据处理流程分析节点输出兼容
可直接放入**生成向量**节点处理

格式示例:
{
  "base_path": "abc123",
  "file_name": "qa_001", 
  "chunk_count": 1,
  "chunks": ["Question: ...\n\nAnswer: ..."],
  "metadata": {
    "source": "personalized_training",
    "question": "...",
    "answer": "..."
  }
}
```

#### 4. 开始导出

点击**"开始处理"**按钮:
- 等待处理
- 完成后提示成功,并显示文件路径

---

## 导出格式说明

### SFT格式深度解析

#### 生成的文件

```
输出目录/
├── mymodel_20231130120000_50.jsonl          # 明文格式
└── chat_dataset/
    └── mymodel_20231130120000_50_train.jsonl # 向量化格式(可直接训练)
```

#### 明文文件内容

每行一个JSON对象,包含messages字段:

```json
{"messages": [
  {"role": "user", "content": "用户问题"},
  {"role": "assistant", "content": "AI回答"}
]}
```

如果有思考过程,会整合到assistant回答中:

```json
{"messages": [
  {"role": "user", "content": "复杂问题"},
  {"role": "assistant", "content": "<thinking>\n思考过程\n</thinking>\n\n最终答案"}
]}
```

#### 向量化文件内容

包含input_ids和label,可直接用于训练:

```json
{
  "input_ids": [1, 2, 3, ...],  // token IDs
  "label": [-100, -100, 5, ...]  // 训练标签(-100表示不计算loss)
}
```

#### 数据处理逻辑

1. **模型家族检测**:
   - 自动检测目标模型类型(Qwen/LLaMA)
   - 根据模型选择tokenizer模板

2. **内容过滤**:
   - 启用质量过滤:移除过短或重复内容
   - 敏感词过滤:自动屏蔽不当内容

3. **智能分块**:
   - 如果单条问答超过 **全局设置中最大输出长度tokens数**
   - 自动将答案拆分为多个chunk
   - 保持问题完整性,仅分块答案

4. **去重处理**:
   - 使用内容哈希检测重复
   - 自动跳过已存在的问答对

5. **向量化**(仅SFT格式):
   - 使用tokenizer将文本转换为token IDs
   - 生成训练标签(user部分标记为-100,assistant部分正常)

#### 模型模板兼容性(重要)

**当前支持的模型家族**:
- **Qwen系列**(默认):Qwen/Qwen2/Qwen3等
- **LLaMA系列**:LLaMA2/LLaMA3等

**检测规则**:
1. 读取模型目录中的config.json
2. 根据`architectures`或`model_type`字段判断
3. 如果无法判断,默认使用Qwen模板

**模板差异示例**:

```python
# Qwen模板
<|im_start|>user
用户问题<|im_end|>
<|im_start|>assistant
AI回答<|im_end|>

# LLaMA模板  
[INST] 用户问题 [/INST] AI回答

```

**⚠️ 关键注意**:
- **模板不匹配的后果**: 导出时确认目标模型类型.训练数据格式错误,导致训练失败或效果差.

### RAG格式深度解析

#### 生成的文件

```
输出目录/
└── favorite_data_yyyymmdd_hhmmss/
    └── mid_complexity/
        └── opt3_dataset.json
```

**⚠️ 关键注意**:
- 文件必须放在`/mid_complexity/`子目录下并且名称必须为`opt3_dataset.json`,以便RAG向量处理流程正确识别。
- 执行RAG数据生成时的输入目录必须指向`favorite_data_yyyymmdd_hhmmss`目录。不能是更深的`mid_complexity`或上级目录。

#### 文件内容结构

一个JSON数组,每个元素代表一个QA对:

```json
[
  {
    "base_path": "a1b2c3d4",
    "file_name": "qa_12345",
    "chunk_count": 1,
    "chunks": [
      "Question: 什么是机器学习?\n\nAnswer: 机器学习是人工智能的一个分支..."
    ],
    "chunk_hashes": ["a1b2c3d4"],
    "chunk_tokens": [250],
    "metadata": {
      "source": "personalized_training",
      "question": "什么是机器学习?",
      "answer": "机器学习是人工智能的一个分支...",
      "thinking": null,
      "original_id": "12345"
    }
  }
]
```

#### 后续处理流程

```
1. 将导出的JSON文件放入RAG处理流程
2. 仅勾选(**生成向量**)节点和后续节点
3. 生成向量并存入向量数据库
4. 在对话中启用RAG检索即可使用
```

#### 与SFT格式的区别

| 特性 | SFT格式 | RAG格式 |
|-----|--------|---------|
| 用途 | 模型微调训练 | 知识库检索 |
| 输出文件 | 2个(.jsonl) | 1个(.json) |
| 内容结构 | messages数组 | chunk数组 |
| 向量化 | 自动完成 | 需后续处理 |
| 是否需要Python环境 | 推荐安装 | 不需要 |
| 模型模板依赖 | 强依赖 | 无依赖 |

---

## 重要注意事项

### 1. 模型模板匹配问题

**问题描述**:
系统默认使用Qwen模型模板,如果您的目标训练模型不是Qwen系列,可能出现模板不匹配。

**影响**:
- 训练数据格式错误
- 模型无法正确学习
- 训练loss异常或不收敛

**解决方案**:

#### 方案1:使用Qwen系列模型(推荐)
```
优点:无需任何配置,开箱即用
缺点:限制模型选择
```

#### 方案2:检查模型家族检测
```
1. 导出SFT数据时查看日志
2. 确认"Detected model family"是否正确
3. 如果错误,说明模型config.json信息不标准
```

#### 方案3:RAG格式绕过问题
```
如果仅用于RAG知识库:
1. 选择导出RAG格式(无模板依赖)
2. 后续在RAG流程中处理
```

**未来改进方向**:
- 支持用户自定义模板选择
- 扩展更多模型家族的自动检测
- 提供模板配置界面

### 2. 分词精度问题

**轻量分词的局限性**:

未安装Python环境时,使用估算分词:
- 基于字符长度粗略估算token数
- 可能导致分块边界不准确
- 对训练效果有轻微影响

**建议**:
- 如果数据质量要求高,安装Python环境
- 如果仅用于RAG,无需担心此问题

### 3. 数据质量控制

**质量过滤的作用**:

启用质量过滤后:
- ✅ 保留:有意义的完整问答对
- ❌ 跳过:过短内容(如"好的"、"谢谢")
- ❌ 跳过:重复的问答对

**最小字符长度**:
```
默认:2字符
建议:根据实际需求调整
- 通用对话:2-5字符
- 专业问答:10字符以上
```

### 4. 数据量建议

| 用途 | 最少数据量 | 推荐数据量 | 说明 |
|-----|----------|----------|------|
| 测试训练流程 | 10条 | 50条 | 验证功能可用性 |
| 风格微调 | 100条 | 500条 | 调整回答风格和语气 |
| 领域微调 | 500条 | 2000条 | 学习特定领域知识 |
| RAG知识库 | 50条 | 不限 | 越多越好,重质量 |

### 5. 文件管理

**输出文件命名规则**:

SFT格式:
```
{导出名称}_{批次号}_{数量}.jsonl
示例:customer_service_20231130120000_150.jsonl
```

RAG格式:
```
opt3_dataset_rag_{导出名称}_{批次号}.json
示例:opt3_dataset_rag_customer_service_20231130120000.json
```

**建议的目录结构**:
```
训练数据/
├── 客服领域/
│   ├── customer_service_v1_20231130120000_200.jsonl
│   └── chat_dataset/
│       └── customer_service_v1_20231130120000_200_train.jsonl
├── 技术支持/
│   └── tech_support_v1_20231201100000_300.jsonl
└── RAG知识库/
    └── opt3_dataset_rag_faq_20231202080000.json
```

---

## 使用技巧

### 1. 渐进式数据收集

**阶段性积累**:
```
第1周:收集10-20条,测试导出流程
第2周:收集50-100条,尝试训练验证
第3周:收集200+条,正式微调模型
```

**主题聚焦**:
- 不要混合多个领域的数据
- 同一次导出的数据应主题一致

### 2. 数据质量优先

**收藏标准**:
- ✅ 回答准确、逻辑清晰
- ✅ 长度适中(50-500字)
- ✅ 问题具有代表性
- ❌ 闲聊或无意义对话
- ❌ 回答错误或含糊不清

**编辑改进**:
- 点赞后可进入管理界面编辑
- 修正AI回答中的小错误
- 补充遗漏的关键信息

### 3. 合理使用两种格式

**选择SFT格式的场景**:
```
✓ 想让模型学习特定的回答风格
✓ 需要模型记住专业知识
✓ 有足够的数据量(100+条)
✓ 愿意投入训练时间和资源
```

**选择RAG格式的场景**:
```
✓ 数据量较少(<100条)
✓ 知识更新频繁
✓ 不想修改基础模型
✓ 需要可解释的检索来源
```

### 4. 批量处理策略

**分批导出**:
```
方案1:按主题分批
- 第1批:产品咨询(100条)
- 第2批:售后服务(150条)  
- 第3批:技术问题(80条)

方案2:按时间分批
- 每周导出一次
- 积累到一定数量再训练
```

**版本管理**:
```
在导出名称中包含版本信息:
- customer_service_v1
- customer_service_v2_refined
- customer_service_v3_final
```

### 5. 验证导出结果

**检查明文文件**:
```bash
# 查看文件行数
wc -l {导出文件}.jsonl

# 查看前几条数据
head -n 3 {导出文件}.jsonl | jq
```

**检查向量化文件**(仅SFT):
```bash
# 查看向量化文件
head -n 1 chat_dataset/{导出文件}_train.jsonl | jq
```

**验证点**:
- 数据条数是否符合预期
- messages格式是否正确
- input_ids数组是否存在(SFT)

---

## 常见问题

### 导出按钮禁用?

**原因**:未选择任何数据

**解决**:勾选至少一条数据后,导出按钮才会启用

---

### 导出失败:未选择输出目录?

**原因**:输出目录字段为必填项

**解决**:点击文件夹图标,选择保存位置

---

### 向量化文件未生成?

**可能原因**:
1. 选择了RAG格式(不生成向量化文件)
2. Python环境未安装且轻量分词失败
3. tokenizer路径配置错误

**解决**:
- 检查导出格式选择
- 安装Python环境后重试

---

### 训练时提示格式错误?

**最可能原因**:模型模板不匹配

**排查步骤**:
1. 确认目标训练模型的类型
2. 如果不匹配:
   - 使用Qwen系列模型,或
   - 导出RAG格式绕过问题

---

### 如何确认数据被正确收藏?

**验证方式**:
1. 点赞后,👍图标变为实心
2. 右下角收藏按钮数字+1
3. 打开数据管理界面,能看到新增数据

---

### RAG格式文件如何使用?

**使用流程**:
```
1. 打开"数据集"页面
2. 选择RAG数据处理流程
3. 将导出的JSON文件放入输入目录
4. 运行**生成向量**节点
5. 完成后在对话设置中启用RAG检索
```

---

完成本章节学习后,您可以继续了解:
- **模型微调训练**:如何使用导出的SFT数据训练模型
- **RAG数据处理**:RAG Pipeline完整流程
- **训练参数调优**:提升训练效果的技巧
