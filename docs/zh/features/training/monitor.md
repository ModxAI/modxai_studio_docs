# 训练监控模块详解

> v1.0.0
> 2025-12

> 📌 **模块定位**：实时监控训练进度，查看历史训练数据，通过可视化图表分析训练状况。

## 目录
- [概述](#概述)
- [界面布局](#界面布局)
- [指标图表](#指标图表)
- [图表数据累积机制](#图表数据累积机制)
- [训练日志](#训练日志)
- [实时监控模式](#实时监控模式)
- [历史回顾模式](#历史回顾模式)
- [使用建议](#使用建议)
- [后续文档](#后续文档)

---

## 概述

监控模块提供两种工作模式：

| 模式 | 触发条件 | 说明 |
|------|----------|------|
| **实时监控** | 选择正在运行的任务 | 实时接收训练指标，图表动态更新 |
| **历史回顾** | 选择已完成/已停止的任务 | 加载历史训练日志，查看完整训练曲线 |

系统会根据选择的任务状态自动切换模式，无需手动设置。

---

## 界面布局

### 任务选择器

页面顶部的任务选择器用于选择要监控的训练任务：

- **下拉列表**：显示所有训练任务，包含任务名称和状态标签
- **状态标签颜色**：
  - 🟢 绿色：运行中
  - 🔵 蓝色：已完成
  - 🟡 黄色：等待中
  - 🔴 红色：失败/错误
  - ⚪ 灰色：已停止

### 训练状态面板

显示当前训练的关键进度信息：

| 指标 | 说明 |
|------|------|
| 当前步数 | 已完成的训练步数 |
| 总步数 | 训练任务的预计总步数 |
| 训练进度 | 完成百分比 |
| 预计剩余时间 | 根据当前速度估算的剩余时间 |

### 实时指标面板

显示最新一步的关键训练指标：

| 指标 | 说明 | 理想趋势 |
|------|------|----------|
| 当前损失 | 模型在当前批次的损失值 | 逐步下降 |
| 学习率 | 当前的学习率值 | 按调度策略变化 |
| 训练速度 | 每秒处理的样本数（SPL/s） | 稳定 |

---

## 指标图表

### 主要图表（默认展示）

#### 损失曲线 / Loss Curve

| 属性 | 说明 |
|------|------|
| **含义** | 模型预测与真实标签之间的差距 |
| **理想趋势** | 整体呈下降趋势，最终趋于平稳 |
| **异常情况** | 持续上升或剧烈震荡表示训练不稳定 |

**分析技巧**：
- 初期快速下降是正常的
- 后期下降变缓属于收敛现象
- 突然上升可能是学习率过大

#### 困惑度曲线 / Perplexity Curve

| 属性 | 说明 |
|------|------|
| **含义** | 模型对下一个 token 的预测不确定性 |
| **计算方式** | perplexity = exp(loss) |
| **理想趋势** | 与损失同步下降 |
| **参考值** | 越低越好，通常个位数到几十 |

**分析技巧**：
- 困惑度是损失的指数形式，更直观反映模型质量
- 困惑度为 10 表示模型平均在 10 个候选词中犹豫

### 其他图表（折叠组）

点击 **"其他图表"** 折叠面板展开更多分析图表：

#### 梯度范数 / Gradient Norm

| 属性 | 说明 |
|------|------|
| **含义** | 梯度向量的 L2 范数，反映参数更新幅度 |
| **理想趋势** | 相对稳定，不出现极端值 |
| **异常情况** | 数值爆炸表示梯度爆炸，需降低学习率 |

**分析技巧**：
- 梯度范数过大（如 >100）说明需要梯度裁剪
- 梯度范数过小（接近 0）可能是梯度消失

#### 学习率曲线 / Learning Rate Curve

| 属性 | 说明 |
|------|------|
| **含义** | 当前优化器使用的学习率值 |
| **理想趋势** | 按设定的调度策略平滑变化 |
| **常见形态** | cosine（余弦衰减）、linear（线性衰减） |

**分析技巧**：
- 预热阶段学习率从 0 逐渐上升
- 正常训练阶段按策略逐渐下降
- 曲线形态应与 `lr_scheduler_type` 参数一致

#### 评估损失 / Evaluation Loss

| 属性 | 说明 |
|------|------|
| **含义** | 在评估集上计算的损失值 |
| **前提条件** | 需要设置评估策略和评估数据 |
| **理想趋势** | 与训练损失同步下降，差距不过大 |

**分析技巧**：
- 训练损失下降但评估损失上升 = 过拟合
- 两者差距过大需要调整正则化参数
- 评估损失是选择最佳检查点的重要依据

#### 训练速度 / Training Speed

| 属性 | 说明 |
|------|------|
| **含义** | 每秒处理的样本数（Samples per Second） |
| **理想趋势** | 保持稳定 |
| **异常情况** | 速度剧烈波动可能是 I/O 瓶颈 |

**分析技巧**：
- 速度与批次大小、序列长度相关
- 保存检查点时速度会短暂下降
- 持续低速需检查数据加载配置

---

## 图表数据累积机制

> ⚠️ **重要特性**：相同任务的训练指标会**累积显示**，而非从头开始。

### 累积显示原理

当同一个训练任务多次训练时（如中断后修改参数重新训练），图表会接续上次的步数继续显示：

**示例场景**：
1. 任务 A 首次训练到第 30 步中断
2. 修改参数后继续训练（从第 0 步开始）
3. 图表 X 轴显示：`30 → 10 → 20 → 30 → 40 ...`

### 累积显示的意义

| 场景 | 作用 |
|------|------|
| 参数调优 | 直观对比不同参数配置的效果 |
| 断点续训 | 完整查看整个训练历程 |
| 问题排查 | 追踪训练中断前后的指标变化 |

### 数据存储

- **历史数据**：保存在本地数据库的 `training_logs` 表
- **页面切换**：切换到其他页面再返回时，图表数据会从缓存恢复

---

## 训练日志

页面底部显示训练过程中的详细日志：

### 日志类型

| 类型 | 颜色 | 说明 |
|------|------|------|
| 训练开始 | 🟢 绿色 | 训练任务启动 |
| 训练步骤 | 🔵 蓝色 | 每个 logging_steps 记录一次 |
| 评估事件 | 🟡 黄色 | 模型评估完成 |
| 检查点保存 | 🔵 蓝色 | 检查点已保存 |
| 训练结束 | 🟢 绿色 | 训练任务完成 |

### 日志存储

- **实时日志**：显示最近 200 条记录
- **完整日志**：保存在本地数据库，可通过历史回顾模式查看
- **持久化**：训练日志在应用关闭后仍然保留

---

## 实时监控模式

### 工作原理
1. 推送频率由 `logging_steps` 参数控制（默认每 10 步推送一次）
2. 前端接收事件后更新图表和指标显示

### 数据更新频率

| 配置项 | 说明 |
|--------|------|
| logging_steps | 每隔多少步记录一次日志 |
| 后端节流 | 约 300ms 的发送间隔 |

### 图表平滑处理

为避免曲线过于抖动，系统采用双重平滑策略：
- **指数平滑（EMA）**：平滑突变数据点
- **滑动平均（MA）**：进一步降噪

---

## 历史回顾模式

### 进入方式

选择状态为 **已完成** 或 **已停止** 的任务，系统自动切换到历史回顾模式。

### 数据加载

1. 从数据库加载该任务的全部训练日志
2. 解析日志中的指标数据
3. 一次性渲染完整训练曲线

### 历史数据上限

- 最多显示 **4000 个数据点**
- 超出部分会自动裁剪最早的记录
- 确保图表性能不受影响

---

## 使用建议

### 监控最佳实践

1. **关注损失曲线**
   - 正常训练：稳步下降后趋于平稳
   - 需要干预：剧烈震荡或持续上升

2. **观察评估损失**
   - 与训练损失同步下降是理想状态
   - 评估损失开始上升时考虑早停

3. **检查梯度范数**
   - 数值稳定说明训练健康
   - 突然变大需要检查数据或降低学习率

### 性能优化

| 场景 | 建议 |
|------|------|
| 长时间训练 | 适当增大 logging_steps 减少数据量 |
| 需要精细监控 | 减小 logging_steps 获取更密集的数据点 |
| 页面卡顿 | 折叠不常用的图表面板 |

---

## 后续文档

- [概述](./overview.md) - 训练功能总览
- [准备模块详解](./prepare.md) - 任务创建和参数配置
- [评估模块详解](./evaluate.md) - 检查点评估
- [测试模块详解](./test.md) - 交互式测试
- [打包模块详解](./package.md) - GGUF 导出
