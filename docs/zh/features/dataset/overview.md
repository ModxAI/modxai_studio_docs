# 数据处理

> v1.0.0
> 2025-12

本文介绍 ModxAI Studio 中**数据处理**功能的使用方法，帮助您将原始数据转换为可用于 SFT 微调训练、RAG 检索和音频转录的标准化数据集。

## 目录

- [环境要求](#环境要求)
- [功能概述](#功能概述)
- [界面布局](#界面布局)
- [数据集类型](#数据集类型)
- [处理流程](#处理流程)
- [配额消耗规则](#配额消耗规则)
- [输出目录与文件](#输出目录与文件)
- [AI 节点特性](#ai-节点特性)
- [断点续跑](#断点续跑)
- [注意事项](#注意事项)

---

## 环境要求

**本功能需在设置中安装额外的CPU或GPU环境依赖。**
- 进入 ModxAI Studio 的**设置**页面
- 在**环境管理**标签页，选择并安装所需的环境（CPU/GPU）
- 安装完成后，返回数据处理页面即可使用相关功能

---

## 功能概述

数据处理模块是 ModxAI Studio 的核心功能之一，提供从原始数据到训练数据集的完整转换流程。主要特点：

- **多数据类型支持**：支持文本、代码、RAG 知识库、音频转文本等多种数据类型
- **流水线式处理**：采用步骤化流水线架构，每个步骤可独立配置
- **AI 增强能力**：通过 AI 节点实现智能数据合成、质量过滤等高级功能
- **断点续跑**：处理失败后可从指定步骤重新开始，避免重复执行已完成的步骤
- **配额管理**：处理过程中的每条数据生成会消耗免费配额

---

## 界面布局

### 外层标签页

页面左侧纵向排列三个主要分类：

| 标签 | 说明 |
|------|------|
| **RAG** | RAG 知识库数据处理，生成向量化数据用于检索增强 |
| **SFT** | 监督微调数据处理，生成用于模型训练的数据集 |
| **MM** | 多媒体处理，目前支持音频转文本 |

### 内层标签页

每个外层分类下包含不同的子功能：

**SFT 分类**：
- **文本**：处理文档类数据（PDF、Word、HTML等）
- **代码**：处理 C/C++、Shader 等代码文件
- **进度监控**：查看当前处理进度和日志

**RAG 分类**：
- **文本**：处理 RAG 知识库源文件
- **进度监控**：查看向量生成和存储进度

**MM 分类**：
- **音频转文本**：将音频文件转录为文本
- **进度监控**：查看转录进度

---

## 数据集类型

### SFT 数据集

用于生成监督微调训练数据，支持两种源数据类型：

**文本数据集**：
- 支持格式：PDF、Word（.doc/.docx）、PowerPoint（.ppt/.pptx）、Excel（.xls/.xlsx）、HTML、文本文件（.txt/.md/.csv/.json/.xml）、ZIP 压缩包
- 输出格式：标准化的 JSONL 训练数据

**代码数据集**：
- 支持格式：C/C++（.c/.cpp/.cc/.h/.hpp）、Shader（.hlsl/.glsl/.cg/.ush/.usf）
- 输出格式：结构化的代码训练数据

### RAG 数据集

用于生成检索增强所需的向量化知识库：

- 支持格式：与文本数据集相同
- 输出格式：向量嵌入数据，存储于向量数据库

### 音频转文本

将音频文件转录为结构化文本：

- 支持格式：MP3、WAV、M4A、WMA
- 输出格式：JSON、SRT 字幕、HTML、Markdown

---

## 处理流程

### SFT 文本/代码处理步骤

| 步骤 | 名称 | 说明 | 必选 |
|------|------|------|------|
| 0 | 转换 | 解析输入文件，转换为统一格式 | ✓ |
| 1 | 清洗 | 清洗和预处理数据 | ✓ |
| 2 | 拆分 | 拆分超长数据块 | ✓ |
| 3 | 分析 | 质量分析和复杂度评估 | ✓ |
| 4 | AI 合成 | 使用 AI 模型合成增强数据 | 可选 |
| 5 | AI 合成解析 | 解析 AI 生成的数据 | 可选 |
| 6 | 转预训练 | 转换为预训练数据格式 | 可选 |
| 7 | 整合 | 整合所有处理后的数据 | ✓ |
| 8 | AI 过滤 | 使用 AI 进行质量评估过滤 | 可选 |
| 9 | AI 过滤解析 | 解析过滤结果 | 可选 |
| 10 | 输出 | 输出最终训练数据 | ✓ |

### RAG 处理步骤

| 步骤 | 名称 | 说明 | 必选 |
|------|------|------|------|
| 0 | 转换 | 解析输入文件 | ✓ |
| 1 | 清洗 | 清洗和预处理 | ✓ |
| 2 | 拆分 | 拆分数据块 | ✓ |
| 3 | 分析 | 质量分析 | ✓ |
| 4 | 生成向量 | 使用向量模型生成嵌入 | ✓ |
| 5 | 存储向量 | 解析并存储到向量数据库 | ✓ |

### 音频转文本处理步骤

| 步骤 | 名称 | 说明 | 必选 |
|------|------|------|------|
| 0 | 模型加载 | 加载音频转文本模型 | ✓ |
| 1 | 转录 | 将音频转录为文本 | ✓ |
| 2 | 输出 | 输出格式化的文本数据 | ✓ |

### 工作流模板

系统预置了多个工作流模板，可快速选择常用的步骤组合：

- **AI 增强模式**：包含 AI 合成步骤，适合需要扩充数据的场景
- **AI 质量模式**：包含 AI 合成和 AI 过滤步骤，适合追求高质量数据
- **预训练模式**：生成预训练格式数据
- **自定义模式**：手动选择需要执行的步骤

---

## 配额消耗规则

数据处理过程会消耗免费配额，规则如下：

### 免费步骤

以下步骤**不消耗**配额：
- 步骤 0（转换/解析）
- 部分步骤 1（清洗）的基础操作

### 消耗配额的步骤

从步骤 1 之后的数据生成操作，**每生成一条数据记录消耗 1 个配额单位**：
- 拆分后产生的每个数据块
- AI 合成生成的每条数据
- AI 过滤处理的每条数据
- 最终输出的每条训练数据

### 查看配额

配额使用情况可在应用顶部状态栏查看。

---

## 输出目录与文件

### SFT 数据集输出

处理完成后，数据按步骤存储在输出目录的子目录中：

```
输出目录/
├── ori/          # 步骤 0：原始解析数据
├── opt1/         # 步骤 1：清洗后数据
├── opt2/         # 步骤 2：拆分后数据
├── opt3/         # 步骤 3：分析后数据
├── opt4/         # 步骤 4：AI 合成数据
├── opt5/         # 步骤 5：AI 合成解析数据
├── opt6/         # 步骤 6：预训练数据
├── opt7/         # 步骤 7：整合数据
├── opt8/         # 步骤 8：AI 过滤数据
├── opt9/         # 步骤 9：AI 过滤解析数据
└── final/        # 步骤 10：最终训练数据
    ├── train/    # 训练集
    │   └── final_dataset.jsonl
    ├── eval/     # 验证集
    │   └── final_dataset.jsonl
    └── test/     # 测试集
        └── final_dataset.jsonl
```

**训练使用**：在训练模块中，选择 `final/train/final_dataset.jsonl` 作为训练数据文件。

### 输出文件命名

各步骤输出文件统一命名规则：

| 步骤 | 文件名 |
|------|--------|
| 步骤 0 | `code_dataset.jsonl` / 按文件类型命名 |
| 步骤 1-9 | `opt{N}_dataset.jsonl` |
| 步骤 10 | `final_dataset.jsonl` |

### 输出格式选择

步骤 10 支持多种输出格式：
- `.jsonl`（默认，推荐用于 SFT 训练）
- `.json`
- `.npy`（NumPy 格式，适合预处理后直接加载）

---

## AI 节点特性

### 模型要求

使用 AI 节点（步骤编号 4、8）需要确保：

1. **模型库中有可用的聊天模型**：AI 节点使用聊天模型进行数据合成和过滤
2. **在步骤参数中选择模型**：点击步骤的设置按钮，选择要使用的 AI 模型

### 处理特性
1. 稳定高效的处理**大规模数据**
2. **进度跟踪与恢复**
3. **异常数据块自动修复**,重新启动后首先尝试自动修复异常数据块
4. **增量处理** 避免重复处理已完成的数据
5. **模型状态监控**, 发现异常自动重启模型以及超时重试机制

### 模型复用机制

SFT 数据处理中的 AI 节点支持复用已加载的聊天模型：

- 如果聊天界面已加载模型，且配置（基础模型 + LoRA）与 AI 节点需要的一致
- 系统会自动检测并复用该模型，请求进入队列排队处理
- 多个请求通过队列机制串行处理，互不干扰
- **SFT 任务完成后不会卸载模型**，您的聊天会话不受影响

### RAG 向量模型

RAG 数据处理的步骤编号 11（生成向量）需要：

1. **模型库中有向量模型（Embedding）**
2. **在设置中安装环境**：向量模型需要 CPU 或 GPU 环境支持
3. 在步骤参数中选择向量模型

---

## 断点续跑

### 使用场景

- 某个步骤执行失败后，可从失败的步骤重新开始
- 修改某个步骤的参数后，只需重新执行该步骤及后续步骤
- 中断处理后，可从上次停止的位置继续

### 操作方法

1. **取消勾选已完成的步骤**：在步骤选择区域，取消勾选不需要重新执行的步骤
2. **保留需要执行的步骤**：勾选需要重新开始的步骤及其后续步骤
3. **点击开始处理**：系统将从第一个勾选的步骤开始执行

### 注意事项

- 确保前置步骤的输出数据存在且有效
- 如果修改了前置步骤的参数，建议重新执行该步骤
- 步骤之间存在数据依赖，跳过中间步骤可能导致数据不完整

---

## 注意事项

### 环境要求

| 功能 | 环境要求 |
|------|---------|
| SFT 文本处理 | 无需在**设置**中安装环境（基础步骤）|
| SFT 代码处理 | 需在**设置**中安装环境（解析步骤依赖 libclang）|
| SFT AI 节点 | 需要聊天模型已导入 |
| RAG AI 节点 | 需要聊天模型已导入 |
| RAG 向量生成 | 需要向量模型已导入，需要在**设置**中安装环境 + 向量模型 |
| 音频转文本 | 需要在**设置**中安装环境 (推荐 GPU 环境) |

### 常见问题

**Q：处理过程中可以切换到其他页面吗？**

A：可以。处理任务在后台运行，切换页面不影响处理进度。返回数据处理页面时可查看最新状态。

**Q：如何查看处理日志？**

A：切换到"进度监控"标签页，可查看实时处理日志。支持按日志级别（INFO/WARNING/ERROR）过滤显示。

**Q：AI 节点处理很慢怎么办？**

A：AI 节点需要调用 AI 模型进行推理，处理速度取决于模型大小和硬件配置。建议：
- 使用较小的模型进行快速处理
- 确保 GPU 可用以加速推理
- 减少待处理数据量进行测试

**Q：配额用完了还能继续处理吗？**

A：配额用完后，消耗配额的步骤将无法执行。可升级账户获取更多配额，或等待配额重置。

---

## 后续文档

- [SFT 数据处理](./sft.md) - SFT 文本/代码数据处理详细指南
- [RAG 数据处理](./rag.md) - RAG 知识库生成详细指南
- [音频转文本](./audio2text.md) - 音频转录功能详细指南
