# 音频转文本数据处理

> v1.0.0
> 2025-12

本文详细介绍如何使用 ModxAI Studio 的音频转文本功能，将音频文件批量转录为文本数据。

---

## 目录

- [功能简介](#功能简介)
- [模型准备](#模型准备)
- [处理流程](#处理流程)
- [各步骤详解](#各步骤详解)
- [输出格式](#输出格式)
- [注意事项](#注意事项)
- [常见问题](#常见问题)

---

## 功能简介

音频转文本（Audio2Text）功能基于 **faster-whisper** 实现，可以将音频文件批量转录为文本。支持多种音频格式，并提供多种输出格式选择。

**适用场景**：
- 会议录音转录
- 视频字幕生成
- 播客内容整理
- 语音数据集构建

**支持的音频格式**：`.mp3`, `.wav`, `.m4a`, `.wma`

**核心特性**：
- 支持自动语言检测
- 支持 GPU 加速（CUDA）
- VAD（语音活动检测）过滤静音片段
- 实时进度显示和日志输出
- 多种输出格式（JSON、SRT、HTML、Markdown）

---

## 模型准备

### 模型要求

音频转文本使用 **faster-whisper** 格式的模型。模型目录必须包含以下核心文件：

| 文件 | 说明 | 必需 |
|------|------|------|
| `model.bin` | 模型权重文件 | ✓ |
| `vocabulary.json` | 词表文件 | ✓ |
| `config.json` | 配置文件 | - |
| `tokenizer.json` | 分词器文件 | - |

### 获取模型

#### 方式一：通过下载器下载（推荐）

1. 进入「下载」页面
2. 在分类中选择「音频转文本」
3. 选择合适的模型版本下载：
   - **faster-whisper-base**：约 150MB，速度快，适合一般场景
   - **faster-whisper-large-v3**：约 3.3GB，精度最高，适合专业场景

**可用模型列表**：

| 模型名称 | 大小 | 精度 | 速度 | 适用场景 |
|----------|------|------|------|----------|
| faster-whisper-base | ~150MB | 中等 | 最快 | 日常使用、快速转录 |
| faster-whisper-small | ~500MB | 较高 | 快 | 平衡精度与速度 |
| faster-whisper-medium | ~1.5GB | 高 | 中等 | 多语言混合场景 |
| faster-whisper-large-v3 | ~3.3GB | 最高 | 较慢 | 专业转录、低质量音频 |

#### 方式二：手动下载

从 HuggingFace 或 ModelScope 下载模型文件，解压到本地目录。

- HuggingFace：`https://huggingface.co/Systran/faster-whisper-*`
- ModelScope：`https://www.modelscope.cn/models/Systran/faster-whisper-*`

> ⚠️ **重要说明**：
> 
> 通过下载器下载的模型**不会自动导入到模型库**。使用时需要在处理界面中**手动选择本地模型目录**。
> 
> 请确保选择的目录中包含 `model.bin` 文件，否则将无法加载模型。

---

## 处理流程

音频转文本处理包含 3 个步骤：

| 步骤 | 名称 | 说明 | 可配置 |
|------|------|------|--------|
| 0 | 模型加载 | 加载 faster-whisper 模型 | ✓ |
| 1 | 转录 | 将音频转换为文本 | ✓ |
| 2 | 输出 | 生成指定格式的输出文件 | ✓ |

**处理逻辑**：
1. 加载指定的 faster-whisper 模型到内存/显存
2. 按文件修改时间倒序扫描输入目录
3. 逐个转录音频文件，实时输出进度
4. 生成多格式输出文件
5. 处理完成后自动卸载模型释放资源

---

## 各步骤详解

### 步骤 0：模型加载

**作用**：加载 faster-whisper 模型到内存或显存。

#### 可配置参数

| 参数 | 说明 | 默认值 | 选项/范围 |
|------|------|--------|-----------|
| **模型路径** | 本地模型目录路径 | - | 必须包含 model.bin |
| **计算精度** | 模型推理精度 | float16 | `float16` / `int8` / `int8_float16` |
| **计算设备** | 运行设备选择 | auto | `auto` / `cuda` / `cpu` |

**高级参数**（折叠区域）：

| 参数 | 说明 | 默认值 | 范围 |
|------|------|--------|------|
| **CPU 线程数** | CPU 模式下的线程数 | 4 | 1-32 |
| **工作进程数** | 并行处理的进程数 | 1 | 1-8 |
| **设备索引** | 多 GPU 时指定使用哪张卡 | 0 | 0-7 |

**计算精度说明**：

| 精度类型 | 说明 | 适用场景 |
|----------|------|----------|
| `float16` | 半精度浮点 | GPU 推荐，速度快，精度高 |
| `int8` | 8位整型量化 | CPU 推荐，内存占用小 |
| `int8_float16` | 混合精度 | GPU 上平衡速度与精度 |

---

### 步骤 1：转录

**作用**：将音频内容转换为文本，识别语音并生成带时间戳的文本片段。

#### 可配置参数

| 参数 | 说明 | 默认值 | 选项/范围 |
|------|------|--------|-----------|
| **搜索束宽** | 解码时的束搜索宽度 | 5 | 1-10 |
| **音频语言** | 指定音频语言 | auto | auto/zh/en/ja/ko/es/fr/de/ru |
| **语音活动检测** | 过滤无语音片段 | 开启 | 开/关 |

**高级参数**（折叠区域）：

| 参数 | 说明 | 默认值 | 范围 |
|------|------|--------|------|
| **重复惩罚** | 抑制重复生成的强度 | 1.1 | 1.0-1.5 |
| **词级时间戳** | 返回每个单词的时间戳 | 关闭 | 开/关 |
| **最小静音时长** | VAD 认定的最小静音时长（毫秒） | 2000 | 100-5000 |

**参数说明**：

**搜索束宽（beam_size）**：
- 值越大，转录结果越准确，但速度越慢
- 推荐值：普通场景 5，高精度需求 8-10

**语音活动检测（VAD）**：
- 开启后会自动过滤静音和无语音片段
- 对于录音质量差或背景噪音大的音频建议开启
- 如果开启后识别片段过少，系统会自动回退重试

**音频语言**：
- `auto`：自动检测语言，适合单语言音频
- 指定语言：对于已知语言的音频，指定语言可提高准确率
- 支持的语言：中文(zh)、英语(en)、日语(ja)、韩语(ko)、西班牙语(es)、法语(fr)、德语(de)、俄语(ru)

---

### 步骤 2：输出

**作用**：将转录结果保存为指定格式的文件。

#### 可配置参数

| 参数 | 说明 | 默认值 | 选项 |
|------|------|--------|------|
| **输出格式** | 输出文件格式（可多选） | json | json/srt/html/md |

---

## 输出格式

每个音频文件会根据选择的格式生成对应的输出文件：

### JSON 格式（默认）

保留完整的转录信息，包括时间戳和元数据：

```json
{
  "file": "meeting_record.mp3",
  "segments": [
    {
      "index": 0,
      "start": 0.0,
      "end": 3.52,
      "text": "大家好，今天我们来讨论项目进度。"
    },
    {
      "index": 1,
      "start": 3.52,
      "end": 7.84,
      "text": "首先请小王汇报一下开发情况。"
    }
  ],
  "info": {
    "language": "zh",
    "language_probability": 0.98
  }
}
```

**字段说明**：
- `segments`：转录片段数组
  - `index`：片段序号
  - `start`/`end`：开始/结束时间（秒）
  - `text`：识别的文本内容
  - `words`：（可选）词级时间戳，启用时才有
- `info`：音频信息
  - `language`：检测到的语言
  - `language_probability`：语言检测置信度

### SRT 格式

标准字幕格式，可直接用于视频播放器：

```srt
1
00:00:00,000 --> 00:00:03,520
大家好，今天我们来讨论项目进度。

2
00:00:03,520 --> 00:00:07,840
首先请小王汇报一下开发情况。
```

### HTML 格式

带样式的网页格式，便于在浏览器中预览：

```html
<!DOCTYPE html>
<html>
<head>
  <title>meeting_record</title>
  <style>
    .seg { margin: 8px 0; }
    .ts { color: #888; margin-right: 8px; }
  </style>
</head>
<body>
  <div class="seg">
    <span class="ts">[0.00 - 3.52]</span>
    大家好，今天我们来讨论项目进度。
  </div>
  ...
</body>
</html>
```

### Markdown 格式

简洁的列表格式，适合文档编辑：

```markdown
# meeting_record

- [0.00s - 3.52s] 大家好，今天我们来讨论项目进度。
- [3.52s - 7.84s] 首先请小王汇报一下开发情况。
```

---

## 注意事项

### 模型加载

1. **模型目录验证**：选择目录时会自动检查是否包含 `model.bin` 和 `vocabulary.json`
2. **显存占用**：large-v3 模型需要约 4GB 显存，请确保 GPU 有足够空间
3. **首次加载**：首次加载模型可能需要较长时间，请耐心等待

### 转录质量

1. **音频质量**：清晰的音频会获得更好的转录效果
2. **背景噪音**：噪音较大时建议开启 VAD 过滤
3. **多语言混合**：对于多语言混合的音频，建议使用 large 模型并设置语言为 auto

### 资源管理

1. **自动卸载**：处理完成后模型会自动卸载，释放内存/显存
2. **中断处理**：如果处理过程中停止，模型不会立即卸载（避免崩溃），会在下次操作时清理
3. **临时文件**：处理过程中会生成 `.transcribing.json` 临时文件，完成后自动删除

### 性能优化

1. **GPU 加速**：有 NVIDIA GPU 时优先使用 CUDA，速度提升明显, 建议安装 [cudnn](https://developer.nvidia.com/cudnn)
2. **精度选择**：
   - GPU：推荐 `float16`
   - CPU：推荐 `int8`（速度更快，内存更小）
3. **批量处理**：系统会按文件修改时间倒序处理，最新文件优先

---

## 常见问题

### Q: 模型加载失败，提示找不到 model.bin？

A: 请检查以下几点：
1. 确认选择的是正确的模型目录（包含 model.bin 的那一层）
2. 如果是解压的模型，确保没有多余的嵌套目录
3. 模型文件是否下载完整（可以对比文件大小）

### Q: 转录结果为空或片段很少？

A: 可能是 VAD 过滤过于激进，系统会自动尝试关闭 VAD 重新转录。如果仍然问题：
1. 检查音频文件是否正常（可以用播放器播放）
2. 尝试手动关闭 VAD 再处理
3. 对于背景音乐较多的音频，可能会影响识别

### Q: 为什么下载的模型没有出现在模型库？

A: 这是设计如此。faster-whisper 模型是专用格式，与 llama.cpp 等模型不同，不会自动导入到统一的模型库。使用时需要在处理界面手动选择模型目录路径。

### Q: GPU 显存不足怎么办？

A: 可以尝试以下方案：
1. 使用更小的模型（如 base 或 small）
2. 将计算精度改为 `int8_float16`
3. 切换到 CPU 模式（速度会变慢）
4. 关闭其他占用显存的程序

### Q: 转录速度很慢？

A: 提升速度的方法：
1. 确保使用 GPU 而非 CPU
2. 使用更小的模型（base 模型速度最快）
3. 降低 beam_size 到 3-4
4. 使用 `float16` 精度

### Q: 支持实时转录吗？

A: 当前版本为批量处理模式，不支持实时流式转录。音频文件需要完整上传后才能开始处理。

### Q: 如何选择合适的模型？

A: 根据您的需求选择：

| 需求 | 推荐模型 |
|------|----------|
| 快速转录，对精度要求不高 | faster-whisper-base |
| 日常会议录音 | faster-whisper-small |
| 多语言混合场景 | faster-whisper-medium |
| 专业级转录、嘈杂环境 | faster-whisper-large-v3 |

---

*如有其他问题，请参考项目文档或在社区提问。*
